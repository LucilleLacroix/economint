<h1 style="text-align:center;">Résumé des dépenses</h1>

<div style="display:flex; flex-direction:column; align-items:center; gap:20px; margin-bottom:20px;">
  <!-- Formulaire de filtre -->
  <div style="margin-bottom:20px;">
    <%= form_with url: expenses_path, method: :get, local: true, class: "form-inline" do %>
      <label>Du : </label>
      <%= date_field_tag :start_date, params[:start_date] || 1.month.ago.to_date, class: "form-control mx-2" %>
      <label>Au : </label>
      <%= date_field_tag :end_date, params[:end_date] || Date.today, class: "form-control mx-2" %>
      <%= submit_tag "Filtrer", class: "btn btn-primary mx-2" %>
      <%= link_to "Réinitialiser", expenses_path, class: "btn btn-secondary" %>
    <% end %>
  </div>

  <!-- Pie chart avec Stimulus -->
  <div style="width:400px; height:400px;">
    <canvas id="expensesChart"
            data-controller="transactions-chart"
            data-transactions-chart-resource-value="expenses"
            data-transactions-chart-chart-id-value="expensesChart"
            data-transactions-chart-categories-value='<%= raw current_user.categories.for_expenses.to_json(only: [:name, :color]) %>'
            data-transactions-chart-data-by-category='<%= raw @expenses_by_category.to_json %>'>
    </canvas>
  </div>

  <!-- Boutons -->
  <div style="display:flex; gap:20px;">
    <%= link_to "Ajouter une dépense", new_expense_path, class: "btn btn-primary" %>
    <%= link_to "Gérer les catégories", categories_path(category_type: "expense"), class: "btn btn-secondary" %>
  </div>
</div>

<!-- Tableau des dépenses -->
<div style="width:90%; max-width:900px; margin:auto;">
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Catégorie</th>
        <th>Description</th>
        <th>Montant</th>
        <th>Date</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% @expenses.each do |expense| %>
        <tr data-expense-id="<%= expense.id %>">
          <td><%= expense.category&.name || "Default" %></td>
          <td><%= expense.description %></td>
          <td><%= number_to_currency(expense.amount) %></td>
          <td><%= expense.date %></td>
          <td>
            <%= link_to "Éditer", edit_expense_path(expense), class: "btn btn-sm btn-warning" %>
            <button class="btn btn-sm btn-danger delete-expense" data-id="<%= expense.id %>">Supprimer</button>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
