<h1 class="text-center mb-4">Résumé des revenus</h1>

<div class="d-flex flex-column align-items-center gap-3 mb-4">

  <!-- Formulaire de filtre -->
  <div class="mb-3">
    <%= form_with url: revenues_path, method: :get, local: true, class: "form-inline" do %>
      <label>Du :</label>
      <%= date_field_tag :start_date, params[:start_date] || 1.month.ago.to_date, class: "form-control mx-2" %>
      <label>Au :</label>
      <%= date_field_tag :end_date, params[:end_date] || Date.today, class: "form-control mx-2" %>
      <%= submit_tag "Filtrer", class: "btn btn-primary mx-2" %>
      <%= link_to "Réinitialiser", revenues_path, class: "btn btn-secondary" %>
    <% end %>
  </div>

  <!-- Pie chart avec Stimulus -->
  <div class="chart-container" style="width:400px; height:400px;">
    <canvas
      id="revenues_chart"
      data-controller="transactions-chart"
      data-transactions-chart-resource-value="revenues"
      data-transactions-chart-chart-id-value="revenues_chart"
      data-transactions-chart-categories-value="<%= current_user.categories.for_revenues.to_json(only: [:name, :color]) %>"
      data-transactions-chart-data-by-category-value="<%= @revenues_by_category.to_json %>">
    </canvas>
  </div>

  <!-- Boutons -->
  <div class="d-flex gap-3">
    <%= link_to "Ajouter un revenu", new_revenue_path, class: "btn btn-primary" %>
    <%= link_to "Gérer les catégories", categories_path(category_type: "revenue"), class: "btn btn-secondary" %>
  </div>
</div>

<!-- Tableau des revenus -->
<div class="table-responsive w-100" style="max-width:900px; margin:auto;">
  <table class="table table-striped align-middle text-center">
    <thead class="table-light">
      <tr>
        <th>Catégorie</th>
        <th>Description</th>
        <th>Montant</th>
        <th>Date</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="revenues_table_body">
      <% @revenues.each do |revenue| %>
        <tr data-revenue-id="<%= revenue.id %>">
          <td><%= revenue.category&.name || "Default" %></td>
          <td><%= revenue.description %></td>
          <td><%= number_to_currency(revenue.amount, unit: "€") %></td>
          <td><%= revenue.date %></td>
          <td>
            <%= link_to "Éditer", edit_revenue_path(revenue), class: "btn btn-sm btn-warning" %>
            <button class="btn btn-sm btn-danger delete-revenue" data-id="<%= revenue.id %>">Supprimer</button>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
