<%# Dépenses sur la période %>
<% spent = current_user.expenses
                      .where(category_id: budget.category_id)
                      .where(date: budget.start_date..budget.end_date)
                      .sum(:amount).to_f %>

<% pess_limit = budget.pessimistic_amount.to_f %>
<% spent_abs  = spent.abs %>

<%# Déterminer la classe CSS en fonction de l'état du budget %>
<%
  computed_row_class =
    if spent_abs > pess_limit
      # 1️⃣ Budget dépassé -> gris (peu importe les dates)
      "budget-row-over"
    elsif budget.end_date.present? && budget.end_date < Date.current
      # 2️⃣ Période terminée & budget pas dépassé -> doré
      "budget-row-gold"
    else
      # 3️⃣ Période en cours & budget pas dépassé -> normal
      ""
    end
%>

<tr id="budget_<%= budget.id %>"
    class="budget-row <%= computed_row_class %>"
    data-controller="budget"
    data-budget-opti-value="<%= budget.optimistic_amount %>"
    data-budget-real-value="<%= budget.realistic_amount %>"
    data-budget-pess-value="<%= budget.pessimistic_amount %>"
    data-budget-spent-value="<%= spent %>">

  <!-- Catégorie -->
  <td data-label="Catégorie"><%= budget.category.name %></td>

  <!-- Période -->
  <td data-label="Période">
    <%= l(budget.start_date, format: :short) %> – <%= l(budget.end_date, format: :short) %>
  </td>

  <!-- Dépenses réelles -->
  <td data-label="Dépenses">
    <%= number_to_currency(spent) %>
  </td>

  <!-- Optimiste -->
  <td data-label="Optimiste" id="budget-opti-<%= budget.id %>">
    <%= number_to_currency(budget.optimistic_amount) %>
    <div class="budget-progress-container">
      <div class="budget-progress-opti" data-budget-target="optiBar" id="opti-bar-<%= budget.id %>"></div>
    </div>
  </td>

  <!-- Réaliste -->
  <td data-label="Réaliste" id="budget-real-<%= budget.id %>">
    <%= number_to_currency(budget.realistic_amount) %>
    <div class="budget-progress-container">
      <div class="budget-progress-real" data-budget-target="realBar" id="real-bar-<%= budget.id %>"></div>
    </div>
  </td>

  <!-- Pessimiste -->
  <td data-label="Pessimiste" id="budget-pess-<%= budget.id %>">
    <%= number_to_currency(budget.pessimistic_amount) %>
    <div class="budget-progress-container">
      <div class="budget-progress-pess" data-budget-target="pessBar" id="pess-bar-<%= budget.id %>"></div>
    </div>
  </td>

  <!-- Actions -->
  <td class="actions-cell">
    <%= link_to edit_budget_path(budget), class: "btn-action edit", title: "Éditer" do %>
      <i class="fas fa-pencil-alt"></i>
    <% end %>

    <%= button_to budget_path(budget),
        method: :delete,
        data: { turbo_confirm: "Supprimer ce budget ?" },
        class: "btn-action delete" do %>
      <i class="fas fa-trash"></i>
    <% end %>
  </td>
</tr>
